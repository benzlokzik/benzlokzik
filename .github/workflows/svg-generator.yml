name: generate snake animation

on:
  # run automatically every 18 hours
  schedule:
    - cron: "0 */18 * * *"

  # allows to manually run the job at any time
  workflow_dispatch:

  # run on every push on the master branch
  push:
    branches:
      - main

jobs:
  generate-snake:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Generates a snake game from a GitHub user's contributions graph,
      # outputting an svg animation
      - name: generate github-contribution-grid-snake.svg
        uses: Platane/snk/svg-only@v3.2.0
        id: generate-snake
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # Copy the generated SVGs to the ./img directory in the project root
      - name: Copy SVGs to ./img
        run: |
          mkdir -p ./img/grid-snakes
          if [ -f "dist/github-contribution-grid-snake.svg" ]; then
            cp dist/*.svg ./img/grid-snakes/
            echo "Snake SVGs copied successfully"
          else
            echo "No snake SVGs found to copy"
          fi

      - name: Upload generated snakes SVGs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: svg-artifacts-snakes
          path: ./img

  commit-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # This job depends on the completion of the snake generation job
    needs: [generate-snake]
    if: |
      always()

    steps:
      # Check out the repository with write permissions
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Download SVGs from artifacts
        uses: actions/download-artifact@v4
        with:
          # Download all artifacts that start with 'svg-artifacts-'
          pattern: svg-artifacts-*
          merge-multiple: true
          path: ./img

      # Commit and push the SVGs to the repository
      - name: Commit and push SVGs
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Verify that we have actual SVG files before committing
          SVG_COUNT=$(find ./img -name "*.svg" -type f 2>/dev/null | wc -l)
          if [ "$SVG_COUNT" -eq 0 ]; then
            echo "Error: No SVG files found in ./img directory. Aborting commit to prevent data loss."
            exit 1
          fi
          
          echo "Found $SVG_COUNT SVG file(s) to process"
          git add ./img/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected, committing..."
            git diff --cached --name-only
            git commit -m "Update SVGs in \`./img\` at \`$(date +"%Y-%m-%d %H:%M:%S")\`"
            git push origin HEAD:main
            echo "Changes committed and pushed successfully"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
